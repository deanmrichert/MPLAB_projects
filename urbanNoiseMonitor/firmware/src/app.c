#include "app.h"

APP_DATA appData;

BiQuad filter_22_44[FILTER_ORDER] = 
{
 {.b={(float)2.6434957379479349952534689136027144340355697206914643848651991220322088338434696197509765625E-17,(float)5.286991475895869990506937827205428868071139441382928769730398244064417667686939239501953125E-17,(float)2.6434957379479349952534689136027144340355697206914643848651991220322088338434696197509765625E-17},
  .a={(float)1,(float)-1.9963164770989523244537622304051183164119720458984375,(float)0.99634543057319435721552736140438355505466461181640625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9969116580901840052320039831101894378662109375,(float)0.99695136361636638167027513190987519919872283935546875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9969701546813130033086736148106865584850311279296875,(float)0.9969897919064762970009496712009422481060028076171875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.998153469895293188329787881230004131793975830078125,(float)0.9981678022374271819217028678394854068756103515625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.998769479305925411694033755338750779628753662109375,(float)0.998816259253499705295098465285263955593109130859375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9993836150595731826484779958263970911502838134765625,(float)0.9993957987839603429591761596384458243846893310546875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_44_88[FILTER_ORDER] = 
{
 {.b={(float)1.680610240145450237425338848235572864520633094669033180679207362118177115917205810546875E-15,(float)3.36122048029090047485067769647114572904126618933806636135841472423635423183441162109375E-15,(float)1.680610240145450237425338848235572864520633094669033180679207362118177115917205810546875E-15},
  .a={(float)1,(float)-1.9925885870322266324450311003602109849452972412109375,(float)0.9927041892404868672628026615711860358715057373046875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.993753466145153030453229803242720663547515869140625,(float)0.99391204528862198142036277204169891774654388427734375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.993910173718122624819670818396843969821929931640625,(float)0.99398860435457780937440475099720060825347900390625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.996281660764576582067775234463624656200408935546875,(float)0.9963389374936360010082125882036052644252777099609375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.99744693851683496887972069089300930500030517578125,(float)0.997633945491424700691140969865955412387847900390625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9987432352995291306996250568772666156291961669921875,(float)0.998791955333090175628285578568466007709503173828125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_88_177[FILTER_ORDER] = 
{
 {.b={(float)1.1355139101502275310682867594981793456384265572634006957741803489625453948974609375E-13,(float)2.271027820300455062136573518996358691276853114526801391548360697925090789794921875E-13,(float)1.1355139101502275310682867594981793456384265572634006957741803489625453948974609375E-13},
  .a={(float)1,(float)-1.9848209514550145815547921301913447678089141845703125,(float)0.985285112838620857900195915135554969310760498046875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9870649288943516008743017664528451859951019287109375,(float)0.9877037059735911395108587385038845241069793701171875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9875759813258715436035117818391881883144378662109375,(float)0.98788993265475022464983112513436935842037200927734375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9924000428920900507279156954609788954257965087890625,(float)0.992628990024225554833492424222640693187713623046875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.994455675360141899687960176379419863224029541015625,(float)0.99521118730974988952908688588649965822696685791015625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.997372078121566030262101776315830647945404052734375,(float)0.99756685913874931781464283631066791713237762451171875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_177_354[FILTER_ORDER] = 
{
 {.b={(float)6.842569388638993416428202044775558170186524620248746941797435283660888671875E-12,(float)1.368513877727798683285640408955111634037304924049749388359487056732177734375E-11,(float)6.842569388638993416428202044775558170186524620248746941797435283660888671875E-12},
  .a={(float)1,(float)-1.9691205970645155876042053932906128466129302978515625,(float)0.97097076210177812871648939108126796782016754150390625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9731937546642956959885850665159523487091064453125,(float)0.97573614128646746213036067274515517055988311767578125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.974775654877665598263547508395276963710784912109375,(float)0.97603334672090846790837304070009849965572357177734375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9844301899065737160299249808304011821746826171875,(float)0.98535190539509265317263952965731732547283172607421875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.987503337747994702766618502209894359111785888671875,(float)0.99051807119499379883365008936380036175251007080078125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9943617200726893035067632808932103216648101806640625,(float)0.995148639344680230323092473554424941539764404296875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_354_707[FILTER_ORDER] = 
{
 {.b={(float)4.0862631871647078121016846634469717181037395903331344015896320343017578125E-10,(float)8.172526374329415624203369326893943436207479180666268803179264068603515625E-10,(float)4.0862631871647078121016846634469717181037395903331344015896320343017578125E-10},
  .a={(float)1,(float)-1.9356592807511905363071491592563688755035400390625,(float)0.94293916980556080620345937859383411705493927001953125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.9422065494309699307251548816566355526447296142578125,(float)0.9522246067924931001158483923063613474369049072265625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.94777387975147320275937090627849102020263671875,(float)0.952739733670129762543865581392310559749603271484375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9673088845666819590718432664289139211177825927734375,(float)0.97096726415261336295969840648467652499675750732421875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9692405025702555132482984845410101115703582763671875,(float)0.981200654560401286374826668179593980312347412109375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9871960854905756921340298504219390451908111572265625,(float)0.9903354707528826406104371926630847156047821044921875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_707_1414[FILTER_ORDER] = 
{
 {.b={(float)2.379581058146253767854319473469548729127609476563520729541778564453125E-8,(float)4.75916211629250753570863894693909745825521895312704145908355712890625E-8,(float)2.379581058146253767854319473469548729127609476563520729541778564453125E-8},
  .a={(float)1,(float)-1.860607170853962433199058068566955626010894775390625,(float)0.8888610024726364411407075749593786895275115966796875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.8676131602979479939818929778994061052799224853515625,(float)0.90665979534276031071016177520505152642726898193359375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.888102877723162986711713529075495898723602294921875,(float)0.90745549389258506334243747915024869143962860107421875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.928267419572597507482214496121741831302642822265625,(float)0.94264330279587016381270814235904254019260406494140625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9155338733936224659970548600540496408939361572265625,(float)0.96278905784237089893196070988778956234455108642578125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.9682726204184046725487178264302201569080352783203125,(float)0.98072502060028787784773385283187963068485260009765625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_1414_2828[FILTER_ORDER] = 
{
 {.b={(float)0.00000125066952534219160870511931837878449869094765745103359222412109375,(float)0.0000025013390506843832174102386367575689973818953149020671844482421875,(float)0.00000125066952534219160870511931837878449869094765745103359222412109375},
  .a={(float)1,(float)-1.6827089199476927827703320872387848794460296630859375,(float)0.78933943552711427482648787190555594861507415771484375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.7485881441405008995815251182648353278636932373046875,(float)0.82233321415990712210941637749783694744110107421875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.674607233298118114106500797788612544536590576171875,(float)0.8227129914446267289207526118843816220760345458984375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.8321441754050342698434405974694527685642242431640625,(float)0.8878569747333191486404757597483694553375244140625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.74429258400331566036811636877246201038360595703125,(float)0.9277604931994318793186948823858983814716339111328125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.912408918568132332183040489326231181621551513671875,(float)0.96158526425630508338571189597132615745067596435546875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_2828_5657[FILTER_ORDER] = 
{
 {.b={(float)0.0000558391784842947658576949032660508009939803741872310638427734375,(float)0.000111678356968589531715389806532101601987960748374462127685546875,(float)0.0000558391784842947658576949032660508009939803741872310638427734375},
  .a={(float)1,(float)-1.23868211998544008878297972842119634151458740234375,(float)0.61831929983571909392736642985255457460880279541015625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.4012441928294787629738493706099689006805419921875,(float)0.6682301957156628890999172654119320213794708251953125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)-1.152684783752002228851551990373991429805755615234375,(float)0.6817865759939838454783966881223022937774658203125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.574976396068434869590646485448814928531646728515625,(float)0.78288801384307171726817387025221250951290130615234375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.1888962604358266350601525118690915405750274658203125,(float)0.86671788428147011895674722836702130734920501708984375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.7322946407725072770489305185037665069103240966796875,(float)0.92273396617786129780824921908788383007049560546875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_5657_11314[FILTER_ORDER] = 
{
 {.b={(float)0.00193761398268565043952194049126092068036086857318878173828125,(float)0.0038752279653713008790438809825218413607217371463775634765625,(float)0.00193761398268565043952194049126092068036086857318878173828125},
  .a={(float)1,(float)-0.1666910418455551934346914322304655797779560089111328125,(float)0.362508575310713176964583226435934193432331085205078125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-0.54340423523275449557701222147443331778049468994140625,(float)0.394545163944260313115819371887482702732086181640625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)0.1412825197194793325206063627774710766971111297607421875,(float)0.508636009276978828808069010847248136997222900390625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-0.875774744757485290591603188659064471721649169921875,(float)0.57267197690438897961229258726234547793865203857421875},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)0.347159354212895732150201411059242673218250274658203125,(float)0.7970776802058925358807073280331678688526153564453125},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-1.1432211088317558722593503262032754719257354736328125,(float)0.8348343625866760930875898338854312896728515625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

BiQuad filter_11314_20000[FILTER_ORDER] = 
{
 {.b={(float)0.0780487804878048641032961540986434556543827056884765625,(float)-0.156097560975609728206592308197286911308765411376953125,(float)0.0780487804878048641032961540986434556543827056884765625},
  .a={(float)1,(float)0.40000000000000002220446049250313080847263336181640625,(float)0.2000000000000000388578058618804789148271083831787109375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)0.048780487804878099045158279523093369789421558380126953125,(float)0.60975609756097581826139730765135027468204498291015625},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)1.9999999999999997779553950749686919152736663818359375,(float)0.9999999999999997779553950749686919152736663818359375},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)-2,(float)1},
  .a={(float)1,(float)-2,(float)1},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)2,(float)1},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
 {.b={(float)1,(float)2,(float)1},
  .a={(float)1,(float)2,(float)1},
  .y={0.0,0.0}, 
  .x={0.0,0.0}},
};

Filter filterBank[NUM_FILTERS] = 
{
 {.sos=filter_22_44},
 {.sos=filter_44_88},
 {.sos=filter_88_177},
 {.sos=filter_177_354},
 {.sos=filter_354_707},
 {.sos=filter_707_1414},
 {.sos=filter_1414_2828},
 {.sos=filter_2828_5657},
 {.sos=filter_5657_11314},
 {.sos=filter_11314_20000},
};

void APP_Initialize ( void )
{
    uint8_t i;
    
    appData.state = APP_STATE_INIT;
    appData.handleFlashDrv = DRV_HANDLE_INVALID;
    appData.timer_40k = DRV_HANDLE_INVALID;
    appData.usart_debugger = DRV_HANDLE_INVALID;
    appData.usart_RN2903 = DRV_HANDLE_INVALID;
    appData.error = NO_ERROR;
    appData.joinProcedure = JOIN_WITH_CURRENT_CONFIG; //FACTORY_RESET; //SET_ALL_PARAMS_AND_SAVE;
    appData.periods_elapsed = 0;
    appData.data_in_idx = 0;
    appData.data_out_idx = 0;
    appData.collectData = false;
    appData.sensor_bias = 0.0;
    appData.filterBank = filterBank;
    
    // load calibration results from flash
    appData.sensor_bias = *(float *)(APP_FLASH_DRV_START_ADDRESS);
    for (i = 0; i < NUM_FILTERS; i++){
        appData.filterBank[i].gain = *(float *)(APP_FLASH_DRV_START_ADDRESS + 4*(i+1));
    }
    
}

void APP_Tasks ( void )
{
    switch ( appData.state )
    {
        case APP_STATE_INIT:
        {
            appData.state = init();
            break;
        }
        case APP_STATE_WAIT_FOR_BUTTON_PRESS:
        {
            appData.state = wait_for_button_press();
            break;
        }
        case APP_STATE_CALIBRATE:
        {
            appData.state = calibrate();
            break;
        }
        case APP_STATE_JOIN:
        {
            appData.state = join();
            break;
        }
        case APP_STATE_IDLE:
        {
            appData.state = idle();
            break;
        }
        case APP_STATE_MEASURE:
        {
            appData.state = measure();
            break;
        }
        case APP_STATE_PROCESS:
        {
            appData.state = process();
            break;
        }
        case APP_STATE_TRANSMIT:
        {
            appData.state = transmit();
            break;
        }
        case APP_STATE_ERROR:
        {
            appData.state = errorHandler();
            break;
        }
        default:
        {
            break;
        }
    }
}